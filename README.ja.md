SavePointsは、プロジェクトのバージョン管理をサポートするBlenderアドオンです。
現在の作業状態を、自動生成されるサムネイル付きのスナップショットとして保存し、いつでも簡単に閲覧・復元することができます。

## 主な機能

- **Incremental Saves**: v001, v002... といったバージョンIDを自動生成し保存します。
- **Visual Previews**: セーブポイントごとのビューポートの状態をサムネイル画像として記録します。
- **Detailed Info**: 各バージョンのオブジェクト数やファイルサイズを表示します。
- **Notes**: 各バージョンに「何を変更したか」の **Note**（メモ）を残せます。
- **Edit Notes**: 履歴リストから既存の **Note** を直接編集できます。
- **Easy Restore**: UI上の履歴リストから、ワンクリックで任意のバージョンを復元できます。
- **Rescue Assets**: 過去のファイル全体を開くことなく、特定のバージョンからオブジェクトだけを現在のシーンにインポート（アペンド）できます。
- **Ghost Reference**: 過去のバージョンをワイヤーフレームとして現在のビューポートに重ねて表示し、変更箇所を視覚的に比較できます。
- **Batch Timelapse**: **(New!)** 複数のバージョンを一括レンダリングし、制作過程のタイムラプス動画を自動生成します。バージョン名の焼き込み機能付き。
- **Context-Aware Rendering**: **(New!)** **現在**のカメラ設定（位置・レンズ・シフト）、ワールド環境、カラーマネジメント（AgX/Filmic）、レンダリング設定を**過去**のスナップショットに適用します。
  <br>*(※コンポジットノードの設定はスナップショット当時のまま維持されます。)*
- **Snapshot Compression**: **(New!)** スナップショットファイルを圧縮するオプションを追加しました。保存時間はわずかに増えますが、ファイルサイズを大幅に削減できます。（デフォルト：**有効**）
- **Quick Save**: **Note** 入力ダイアログをスキップして即座に保存するオプションがあります。
- **Safe Recovery**: 過去のバージョンをメインファイルとして復元する際、元のファイルを自動的にバックアップします。
- **Auto Save**: 設定した間隔（デフォルト10分）で専用スロットに自動保存を行い、作業の消失を防ぎます。
- **Disk Management**: **Lock** されたバージョンを保護しつつ、古いバージョンを自動削除して履歴サイズを管理できます。
- **Version Protection**: 重要なバージョンを **Lock** することで、自動削除や誤削除を防ぎます。
- **Version Tagging**: バージョンに **Tag**（Stable, Milestone, Experiment, Bug）を付与し、履歴リストをフィルタリングできます。

## 使い方

1. **Installation**: アドオンのzipファイルをBlenderにインストールします。
   [Blender Extensions](https://extensions.blender.org/add-ons/savepoints/) からも入手可能です。
2. **Locate the Panel**: 3Dビューポートの **N-Panel** (サイドバー) にある **SavePoints** タブを開きます。
3. **Save a Version**:
   - **Save Version** ボタンをクリックするか、ショートカットを使用します：
     - `Ctrl/Cmd + Alt (Opt) + S`: 通常セーブ (設定によりダイアログを表示)。
     - `Ctrl/Cmd + Alt (Opt) + Shift + S`: 強制クイックセーブ (常にダイアログをスキップ)。
   - **Note** を入力（任意）して確定します。
   - *Tip*: 設定で **"Show Save Dialog"** をオフにすると、標準ショートカットでワンクリック保存が可能になります。
   - `.blend` ファイルと同じ場所に隠しフォルダが作成され、そこに履歴が保存されます。
4. **Restore a Version**:
   - 履歴リストからバージョンを選択します。
   - サムネイル、**Note**、オブジェクト数などを確認できます。
   - **Edit Note**: **Note** 横の鉛筆アイコンをクリックして内容を更新できます。
   - **Rescue Assets**: **Import** アイコンをクリックすると、そのバージョンに含まれるオブジェクトを選択して現在のシーンに追加できます（重いデータの場合は時間がかかることがあります）。
   - **Ghost Reference**: **Ghost** アイコンをクリックすると、そのバージョンのワイヤーフレームがビューポートに重なって表示されます。
   - **Checkout (Restore)** をクリックして、そのバージョンを開きます。
   - **Snapshot Mode** (ビューポートに赤い枠が表示されます) に入ります：
       - **Save as Parent**: このバージョンをメインファイルとして上書き保存します（復元）。
       - **Fork (Save as New)**: 全く新しいプロジェクトとして別名保存します。
       - **Return to Parent**: 変更を保存せずに元のファイルに戻ります。
       - ※復元前のメインファイルは履歴フォルダ内にバックアップされます（例: `.{YourFileName}_history/{YourFileName}.blend.123456.bak`）。
5. **Auto Save**:
   - パネル内でオン/オフと間隔（最短1分）を設定できます。
   - 自動保存は単一の「autosave」スロットを上書きするため、履歴リストを埋め尽くすことはありません。
   - **注**: 処理落ちを防ぐため、自動保存時にはサムネイルは生成されません。
6. **Disk Management & Protection**:
   - **Snapshot Compression**: General設定にあるこのオプションはデフォルトで有効です。ディスク容量を節約したい場合はオンのまま、ファイルサイズよりも保存速度を最優先したい場合はオフにしてください。
   - **Limit Versions**: Disk Management セクションで有効にすると、最新のN件（デフォルト50）のみを保持し、古いものを自動削除します。
   - **Lock Versions**: リストの **Lock** アイコン（鍵マーク）をクリックすると、そのバージョンは保護され、自動削除や手動削除の対象外になります。
   - 新しいバージョンを保存した時、またはリストをリフレッシュした時に、古いバージョンの自動削除が実行されます。
7. **Relinking History**:
   - `.blend` ファイルを移動するなどして履歴フォルダが見つからない場合、**Link Existing History Folder** ボタンが表示されます。既存のフォルダを選択して再接続できます。
   - **※選択した元のフォルダは現在の場所に移動され、元の場所からは削除されますのでご注意ください。**
8. **Export Project**:
   - **File > Export > SavePoints Project (.zip)** を選択します。
   - 現在の `.blend` ファイルと履歴フォルダ一式をまとめたzipファイルを作成します。バックアップや共有に便利です。
9. **Tagging & Filtering**:
   - リストの **Tag** アイコンをクリックしてタグ（Stable, Milestoneなど）を付与できます。
   - リスト上部の **Filter** ドロップダウンで特定のタグのみを表示できます。
10. **Batch Rendering & Timelapse**:
    - **バッチモード起動**: 履歴リスト右上のチェックボックスをオンにします。
    - **バージョン選択**: レンダリングしたいバージョンにチェックを入れます（フィルターと「Select All」を組み合わせると便利です）。
    - **出力設定**: **SCENE**（現在の設定を使用）、**PNG**、**JPEG** から選択します。
    - **レンダリング開始**: **Batch Render Selected** をクリックします。
      - *Note*: レンダラーは、**現在開いているシーンのカメラ、ワールド、レンダリング設定**を過去のバージョンに適用します。
      - **タイムラプス設定**: ダイアログ内で **Create Timelapse MP4** にチェックを入れると動画ファイルを作成できます。**Burn-in Version ID** を有効にすると、バージョン名（例: v001）を動画上に焼き込むことができます（位置は四隅から選択可能）。
      - **ドライラン (Dry Run)**: **"Dry Run"** にチェックを入れると、低解像度（25%）・1サンプルの高速プレビューを実行します。
      - **即時本番レンダリング**: `Shift` を押しながらボタンをクリックすると、**ダイアログをスキップ**して即座に本番レンダリングを開始します（現在の設定を使用）。
      - **キャンセル**: 処理中に `ESC` キーを押すといつでも中断できます。
    - **自動タイムラプス**: 完了後、すべての画像がVSE（ビデオシーケンスエディター）に読み込まれた `..._Timelapse` シーンが自動作成され、すぐに再生可能です。
    - **保存先**: `//renders_batch/{BlendName}_{Timestamp}/` に保存されます。

## ⚠️ 注意事項 (Note)

### バッチレンダリングの制限事項
最大限の安定性を確保するため、バッチレンダラーは **Factory Startup Mode（初期状態）** で動作します。
- **動作するもの**: ジオメトリ、シェーダー、モディファイアー、ジオメトリノード。
- **動作しないもの**: レンダリング時にジオメトリを生成するサードパーティ製アドオン（一部のスキャッター系ツールなど）は読み込まれません。
- **GPUサポート**: ファクトリーモードであっても、保存されたシステム設定（CUDA/OptiX/Metal）を自動検出し、GPUを使用しようと試みます。

### 一般的な注意事項
- GPUがない環境ではサムネイル生成はスキップされますが、バージョン管理機能は問題なく動作します。
- **アセットブラウザ**: スナップショットは独自の拡張子 `.blend_snapshot` で保存されます。これにより Blender のスキャン対象外となり、**アセットブラウザに重複したアセットが表示されるのを防ぎます**。

*旧バージョンからのアップデートユーザーへ: 標準の `.blend` ファイルとして保存された過去のスナップショットは重複の原因になる可能性があります。SavePoints パネルからこれらを削除して整理しても安全です。*

## ❓ FAQ / Troubleshooting

**Q: アドオンをアンインストールしたら、履歴データは消えますか？**
**A: いいえ、消えません。** SavePointsは独自のデータ形式を使用していません。スナップショットファイル（`.blend_snapshot`）は、拡張子が異なるだけの標準的なBlenderファイルです。

**アドオンなしで手動復元する方法:**
1. プロジェクトファイルの横にある隠し履歴フォルダ（`.{ファイル名}_history`）を開きます。
2. 復元したいバージョンのフォルダ（例: `v005`）を開きます。
3. スナップショットファイル（`snapshot.blend_snapshot`）を別の場所（デスクトップなど）にコピーします。
4. 拡張子を `.blend_snapshot` から `.blend` に書き換えます。
5. 通常通りBlenderで開きます。
