name: Release Blender Addon

on:
  push:
    tags:
      - "v*"
  merge_group:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  test-linux:
    name: Test on Linux - Blender ${{ matrix.blender-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        blender-version: [ "4.2.0", "4.5.0", "5.0.0" ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Just
        uses: extractions/setup-just@v3

      - name: Cache Blender
        id: cache-blender
        uses: actions/cache@v4
        with:
          path: blender-bin
          key: blender-${{ runner.os }}-${{ matrix.blender-version }}

      - name: Download Blender
        if: steps.cache-blender.outputs.cache-hit != 'true'
        shell: bash
        run: |
          set -e
          VER="${{ matrix.blender-version }}"
          MAJOR_MINOR=${VER%.*}
          mkdir -p blender-bin

          URL="https://download.blender.org/release/Blender${MAJOR_MINOR}/blender-${VER}-linux-x64.tar.xz"
          echo "Downloading Blender ${VER} for Linux from: $URL"
          curl -SL --fail "$URL" -o blender.tar.xz || { echo "Failed to download Blender"; exit 1; }
          
          tar -xf blender.tar.xz -C blender-bin --strip-components=1
          rm blender.tar.xz

      - name: Setup Blender Path
        shell: bash
        run: |
          echo "$PWD/blender-bin" >> $GITHUB_PATH
          export PATH="$PWD/blender-bin:$PATH"
          
          if ! command -v blender &> /dev/null; then
            echo "::error::blender executable not found in PATH"
            exit 1
          fi
          echo "Blender setup complete."

      - name: Run Tests
        shell: bash
        env:
          BLENDER_EXE: blender
        run: just test-blender

      - name: Create Success Marker
        run: touch success-${{ runner.os }}-${{ matrix.blender-version }}

      - name: Upload Success Marker
        uses: actions/upload-artifact@v4
        with:
          name: success-${{ runner.os }}-${{ matrix.blender-version }}
          path: success-${{ runner.os }}-${{ matrix.blender-version }}

  test-windows:
    name: Test on Windows - Blender ${{ matrix.blender-version }}
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        blender-version: [ "4.2.0", "4.5.0", "5.0.0" ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Just
        uses: extractions/setup-just@v3

      - name: Cache Blender
        id: cache-blender
        uses: actions/cache@v4
        with:
          path: blender-bin
          key: blender-windows-${{ matrix.blender-version }}

      - name: Download Blender
        if: steps.cache-blender.outputs.cache-hit != 'true'
        shell: bash
        run: |
          set -e
          VER="${{ matrix.blender-version }}"
          MAJOR_MINOR=${VER%.*}
          mkdir -p blender-bin

          URL="https://download.blender.org/release/Blender${MAJOR_MINOR}/blender-${VER}-windows-x64.zip"
          echo "Downloading Blender ${VER} for Windows from: $URL"
          curl -SL --fail "$URL" -o blender.zip || { echo "Failed to download Blender"; exit 1; }
          
          unzip -q blender.zip -d blender_temp
          INNER_DIR=$(ls blender_temp | head -n 1)
          mv blender_temp/"$INNER_DIR"/* blender-bin/
          rm -rf blender_temp blender.zip

      - name: Setup Blender Path
        shell: bash
        run: |
          echo "$PWD/blender-bin" >> $GITHUB_PATH
          export PATH="$PWD/blender-bin:$PATH"
          
          if ! command -v blender.exe &> /dev/null; then
            echo "::error::blender.exe executable not found in PATH"
            exit 1
          fi
          echo "Blender setup complete."

      - name: Run Tests
        shell: bash
        env:
          BLENDER_EXE: blender.exe
        run: just test-blender

      - name: Create Success Marker
        shell: bash
        run: touch success-${{ runner.os }}-${{ matrix.blender-version }}

      - name: Upload Success Marker
        uses: actions/upload-artifact@v4
        with:
          name: success-${{ runner.os }}-${{ matrix.blender-version }}
          path: success-${{ runner.os }}-${{ matrix.blender-version }}

  update-badges:
    needs: [ test-linux, test-windows ]
    if: always() && startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Update README Badges
        run: python3 tools/update_badges.py

      - name: Commit and Push
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add README.md
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "docs: update compatibility badges [skip ci]"
            git push
          fi

  build-and-release:
    needs: [ test-linux, test-windows ]
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set output for version name
        id: version
        run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Verify Manifest Version
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/}
          TAG_VERSION=${TAG_VERSION#v}
          MANIFEST_VERSION=$(grep -m 1 "^version =" savepoints/blender_manifest.toml | cut -d '"' -f 2)

          echo "Tag Version: $TAG_VERSION"
          echo "Manifest Version: $MANIFEST_VERSION"

          if [ "$TAG_VERSION" != "$MANIFEST_VERSION" ]; then
            echo "::error::Version mismatch! Tag says '$TAG_VERSION' but manifest says '$MANIFEST_VERSION'"
            exit 1
          fi

      - name: Create Zip File
        run: |
          zip -r ./savepoints_${{ steps.version.outputs.TAG_NAME }}.zip savepoints -x "*.pyc" -x "*__pycache__*"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: savepoints_${{ steps.version.outputs.TAG_NAME }}.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}