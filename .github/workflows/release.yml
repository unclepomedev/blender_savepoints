name: Release Blender Addon

on:
  push:
    tags:
      - "v*"
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  test:
    name: Test - ${{ matrix.os }} - Blender ${{ matrix.blender-version }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        blender-version: ["4.2.0", "4.5.0", "5.0.0"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --frozen || uv sync

      - name: Setup Just
        uses: extractions/setup-just@v3

      - name: Setup Blender with blup
        uses: unclepomedev/setup-blup@v0.0.3
        with:
          blender-version: ${{ matrix.blender-version }}
          cache: true

      - name: Run Tests
        shell: bash
        run: just test-blender ${{ matrix.blender-version }}

      - name: Create Success Marker
        shell: bash
        run: touch success-${{ runner.os }}-${{ matrix.blender-version }}

      - name: Upload Success Marker
        uses: actions/upload-artifact@v4
        with:
          name: success-${{ runner.os }}-${{ matrix.blender-version }}
          path: success-${{ runner.os }}-${{ matrix.blender-version }}

  update-badges:
    needs: [test]
    if: always() && startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: main
          token: ${{ secrets.BOT_TOKEN }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Update README Badges
        run: python3 tools/update_badges.py

      - name: Commit and Push
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add README.md
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "docs: update compatibility badges [skip ci]"
            git push
          fi

  build-and-release:
    needs: [test]
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set output for version name
        id: version
        shell: bash
        run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Verify Manifest Version
        shell: bash
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/}
          TAG_VERSION=${TAG_VERSION#v}
          MANIFEST_VERSION=$(grep -m 1 "^version =" savepoints/blender_manifest.toml | cut -d '"' -f 2)

          echo "Tag Version: $TAG_VERSION"
          echo "Manifest Version: $MANIFEST_VERSION"

          if [ "$TAG_VERSION" != "$MANIFEST_VERSION" ]; then
            echo "::error::Version mismatch! Tag says '$TAG_VERSION' but manifest says '$MANIFEST_VERSION'"
            exit 1
          fi

      - name: Create Zip File
        run: |
          zip -r ./savepoints_${{ steps.version.outputs.TAG_NAME }}.zip savepoints -x "*.pyc" -x "*__pycache__*"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: savepoints_${{ steps.version.outputs.TAG_NAME }}.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}